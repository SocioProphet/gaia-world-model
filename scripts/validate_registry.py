#!/usr/bin/env python3\nimport json,re,sys\nfrom pathlib import Path\nID_RE=re.compile(r\"^sha3-256:[0-9a-f]{64}$\")\ndef die(msg):\n    print(\"ERROR: \"+msg,file=sys.stderr)\n    raise SystemExit(2)\n\ndef load_json(p):\n    try:\n        return json.loads(Path(p).read_text(encoding=\"utf-8\"))\n    except Exception as e:\n        die(\"cannot read json \"+str(p)+\" : \"+str(e))\n\ndef main(argv):\n    if len(argv)!=2:\n        print(\"usage: validate_registry.py <manifest.json>\",file=sys.stderr); return 2\n    m=load_json(argv[1])\n    wires=m.get(\"wires\",[])\n    if wires is None: wires=[]\n    if not isinstance(wires,list): die(\"wires must be an array\")\n    sb=m.get(\"schema_bundle\")\n    for w in wires:\n        if not isinstance(w,dict): die(\"wire entry must be an object\")\n        if w.get(\"type\")!=\"tritrpc\":\n            continue\n        if w.get(\"profile\")!=\"path-a\": die(\"tritrpc wire profile must be path-a\")\n        if w.get(\"payload_encoding\")!=\"avro-binary\": die(\"tritrpc wire payload_encoding must be avro-binary\")\n        for k in [\"service\",\"method\",\"schema_id\",\"context_id\"]:\n            if not w.get(k): die(\"tritrpc wire missing \"+k)\n        if not ID_RE.match(w[\"schema_id\"]) or not ID_RE.match(w[\"context_id\"]): die(\"wire schema_id or context_id format is invalid\")\n        if not isinstance(sb,dict): die(\"schema_bundle is required when wires include tritrpc\")\n        for k in [\"salad_ref\",\"hash_alg\",\"schema_id\",\"context_id\",\"canonicalization\"]:\n            if not sb.get(k): die(\"schema_bundle missing \"+k)\n        if sb.get(\"hash_alg\")!=\"sha3-256\": die(\"schema_bundle.hash_alg must be sha3-256\")\n        if w[\"schema_id\"]!=sb[\"schema_id\"] or w[\"context_id\"]!=sb[\"context_id\"]: die(\"wire schema_id and context_id must match schema_bundle\")\n        canon=sb.get(\"canonicalization\",{})\n        if canon.get(\"avro_map_order\")!=\"lexicographic\": die(\"schema_bundle.canonicalization.avro_map_order must be lexicographic\")\n    print(\"OK: \"+argv[1]); return 0\n\nif __name__==\"__main__\":\n    raise SystemExit(main(sys.argv))\n